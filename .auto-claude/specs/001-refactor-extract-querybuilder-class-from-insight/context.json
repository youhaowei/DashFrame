{
  "task_description": "Add comprehensive test coverage for the QueryBuilder class in @dashframe/engine-browser package. The QueryBuilder class exists with SQL generation capabilities but lacks unit tests.",
  "scoped_services": ["engine-browser"],
  "files_to_modify": {
    "engine-browser": []
  },
  "files_to_create": {
    "engine-browser": [
      "packages/engine-browser/vitest.config.ts",
      "packages/engine-browser/src/query-builder.test.ts",
      "packages/engine-browser/src/insight.test.ts"
    ]
  },
  "files_to_reference": [
    "packages/connector-csv/src/connector.test.ts",
    "packages/connector-csv/vitest.config.ts",
    "packages/engine-browser/src/query-builder.ts",
    "packages/engine-browser/src/insight.ts"
  ],
  "patterns": {
    "test_framework": "Vitest with describe/it blocks and vi.mock() for mocking",
    "test_structure": "Group related tests in describe blocks, use beforeEach for setup",
    "mocking_pattern": "Mock DuckDB connection with vi.fn() returning realistic data structures",
    "file_naming": "[component].test.ts in same directory as source file",
    "vitest_config_pattern": "defineConfig with environment: 'node', globals: true, include: ['**/*.test.{ts,tsx}'], and path aliases for workspace packages"
  },
  "existing_implementations": {
    "query_builder": {
      "file": "packages/engine-browser/src/query-builder.ts",
      "lines": 532,
      "methods": [
        "filter(predicates)",
        "sort(orders)",
        "orderBy(orders)",
        "groupBy(columns, aggregations)",
        "join(other, options)",
        "limit(count)",
        "offset(count)",
        "select(columns)",
        "sql()",
        "toSQL()",
        "rows()",
        "run()",
        "preview(limit)",
        "count()",
        "static batchQuery(conn, queries)"
      ],
      "helper_functions": [
        "formatPredicate(pred)",
        "buildPlan(operations)",
        "buildSelectClause(plan)",
        "buildOrderClause(sorts)",
        "formatValue(value)",
        "quoteIdent(identifier)",
        "makeTableName(dataFrameId)"
      ],
      "key_types": [
        "FilterPredicateLocal",
        "SortOrderLocal",
        "AggregationLocal",
        "JoinOptionsLocal",
        "Operation",
        "QueryPlan"
      ]
    },
    "insight": {
      "file": "packages/engine-browser/src/insight.ts",
      "lines": 506,
      "key_methods": [
        "toSQL()",
        "generateSimpleSQL()",
        "generateJoinSQL()",
        "buildWhereClause(filters)",
        "buildOrderByClause()"
      ],
      "update_methods": [
        "with(updates)",
        "withSelectedFields(fieldIds)",
        "withMetrics(metrics)",
        "withFilters(filters)",
        "withGroupBy(groupBy)",
        "withOrderBy(orderBy)",
        "withLimit(limit)",
        "withName(name)"
      ],
      "utility_methods": [
        "toJSON()",
        "fromJSON(config)",
        "hasAnalytics()",
        "isReady()",
        "getDescription()"
      ],
      "required_types": [
        "InsightConfiguration",
        "DataTableInfo",
        "DataTableField",
        "InsightMetric"
      ]
    },
    "test_reference": {
      "file": "packages/connector-csv/src/connector.test.ts",
      "lines": 398,
      "patterns_to_copy": [
        "vi.mock() for dependency mocking",
        "describe blocks for grouping",
        "beforeEach for test setup",
        "expect assertions for verification"
      ]
    }
  },
  "investigation_findings": {
    "test_coverage_status": "No existing tests in engine-browser package",
    "vitest_config_needed": "packages/engine-browser needs vitest.config.ts",
    "package_test_command": "npm run test (currently passes with --passWithNoTests)",
    "mock_strategy": "Mock AsyncDuckDBConnection to avoid DuckDB-WASM initialization",
    "mock_duckdb_example": "{ query: vi.fn().mockResolvedValue({ toArray: () => mockData }), insertArrowFromIPCStream: vi.fn().mockResolvedValue(undefined) } as unknown as AsyncDuckDBConnection"
  },
  "created_at": "2025-12-31T11:16:39.993479",
  "updated_at": "2025-12-31T12:00:00.000000"
}
