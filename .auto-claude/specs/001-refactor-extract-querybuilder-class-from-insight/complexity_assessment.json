{
  "complexity": "standard",
  "workflow_type": "refactor",
  "confidence": 0.85,
  "reasoning": "QueryBuilder class exists (532 lines at packages/engine-browser/src/query-builder.ts) but serves a DIFFERENT purpose - it's for DuckDB WASM operations with method chaining. Insight.toSQL() does NOT use it. The generateJoinSQL method (lines 260-413, 153 lines) still contains all original complexity with eslint-disable for cognitive-complexity (59). Task requires creating a dedicated InsightQueryBuilder to extract SQL generation logic from Insight, adding comprehensive tests.",

  "analysis": {
    "scope": {
      "estimated_files": 5,
      "estimated_services": 1,
      "is_cross_cutting": false,
      "notes": "Changes confined to packages/engine-browser/src/: insight.ts (modify), new insight-query-builder.ts (create), and test files. Single package, no cross-service impact."
    },
    "integrations": {
      "external_services": [],
      "new_dependencies": [],
      "research_needed": false,
      "notes": "No external integrations. Pure internal refactoring of SQL string generation logic."
    },
    "infrastructure": {
      "docker_changes": false,
      "database_changes": false,
      "config_changes": false,
      "notes": "Pure code refactoring - no infrastructure changes required. Vitest configured with --passWithNoTests flag."
    },
    "knowledge": {
      "patterns_exist": true,
      "research_required": false,
      "unfamiliar_tech": [],
      "notes": "SQL building patterns clearly defined in generateJoinSQL (field aliasing, JOIN construction, aggregation handling, WHERE/ORDER BY clauses). Extract and organize into dedicated class."
    },
    "risk": {
      "level": "medium",
      "concerns": [
        "SQL generation correctness must be preserved during migration",
        "No existing tests to catch regressions (0 test files in engine-browser)",
        "generateJoinSQL has high cognitive complexity (59) - careful refactoring needed",
        "Must handle edge cases: duplicate column names across JOINs, field aliasing, complex aggregations"
      ],
      "notes": "Primary risk is regression in SQL output. Tests are critical to verify behavior preservation before and after refactoring."
    }
  },

  "current_state": {
    "insight_path": "packages/engine-browser/src/insight.ts",
    "insight_lines": 506,
    "generate_join_sql_location": "lines 260-413 (153 lines)",
    "generate_simple_sql_location": "lines 203-257 (54 lines)",
    "helper_methods": ["buildWhereClause (lines 415-434)", "buildOrderByClause (lines 436-440)"],
    "cognitive_complexity": 59,
    "existing_query_builder_purpose": "DuckDB WASM operations with fluent API (filter/sort/join/groupBy) - DIFFERENT from needed InsightQueryBuilder",
    "test_files_found": 0,
    "notes": "The existing QueryBuilder is for DataFrame + DuckDB Connection operations. Insight.toSQL() generates SQL strings from InsightConfiguration with DataTableInfo. These are different concerns requiring a new InsightQueryBuilder class."
  },

  "extraction_plan": {
    "new_class": "InsightQueryBuilder",
    "methods_to_extract": [
      {
        "name": "buildFieldAliasMap",
        "source_location": "generateJoinSQL lines 269-274",
        "description": "Create map from field IDs to their SQL column aliases"
      },
      {
        "name": "buildJoinSelectParts",
        "source_location": "generateJoinSQL lines 305-337",
        "description": "Build SELECT clause parts for JOIN queries with proper aliasing for duplicate column names"
      },
      {
        "name": "buildAggregationQuery",
        "source_location": "generateJoinSQL lines 362-402",
        "description": "Handle metrics, GROUP BY, and aggregation function construction"
      },
      {
        "name": "buildSQLClauses",
        "source_location": "buildWhereClause + buildOrderByClause (lines 415-440)",
        "description": "Construct WHERE, ORDER BY, and LIMIT clauses"
      }
    ]
  },

  "recommended_phases": [
    "discovery",
    "requirements",
    "context",
    "spec_writing",
    "planning",
    "validation"
  ],

  "flags": {
    "needs_research": false,
    "needs_self_critique": false,
    "needs_infrastructure_setup": false
  },

  "validation_recommendations": {
    "risk_level": "medium",
    "skip_validation": false,
    "minimal_mode": false,
    "test_types_required": ["unit", "integration"],
    "security_scan_required": false,
    "staging_deployment_required": false,
    "reasoning": "SQL generation refactoring requires unit tests for each InsightQueryBuilder method and integration tests to verify Insight.toSQL() produces identical SQL output after refactoring. No security-sensitive changes involved."
  },

  "key_files": {
    "primary": [
      "packages/engine-browser/src/insight.ts"
    ],
    "to_create": [
      "packages/engine-browser/src/insight-query-builder.ts",
      "packages/engine-browser/src/__tests__/insight-query-builder.test.ts",
      "packages/engine-browser/src/__tests__/insight.test.ts"
    ],
    "related": [
      "packages/engine-browser/src/query-builder.ts",
      "packages/engine/src/types.ts"
    ]
  },

  "acceptance_criteria": [
    "InsightQueryBuilder class created with methods: buildFieldAliasMap, buildJoinSelectParts, buildAggregationQuery, buildSQLClauses",
    "Insight.toSQL() delegates SQL generation to InsightQueryBuilder",
    "generateJoinSQL method eliminated or significantly simplified (<15 cognitive complexity)",
    "generateSimpleSQL method refactored to use shared clause builders",
    "Unit tests cover all InsightQueryBuilder methods with edge cases",
    "Integration tests verify SQL output equivalence before/after refactoring",
    "No regression in SQL output for existing functionality"
  ],

  "clarifications": {
    "user_assumption": "User believes refactoring is complete but needs tests",
    "actual_state": "Refactoring is NOT complete - Insight still contains all SQL generation logic. The existing QueryBuilder is for a different purpose.",
    "recommendation": "Create dedicated InsightQueryBuilder for Insight SQL generation, not reuse existing QueryBuilder"
  },

  "created_at": "2025-01-07T12:00:00.000Z",
  "updated_at": "2025-01-09T10:30:00.000Z"
}
